<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>EGGSHOT</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; user-select: none; }
        
        #camera-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; filter: brightness(0.9);
        }
        #game-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
        }
        
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
        }

        /* --- TOP BAR LAYOUT --- */
        .top-bar {
            position: absolute; top: 20px; left: 0; width: 100%; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: flex-start; box-sizing: border-box;
            z-index: 20; /* Ensure this is above other HUD elements */
        }

        .left-icons { display: flex; gap: 10px; pointer-events: auto; }
        
        .right-group { 
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: auto; 
        }
        
        .stats-row { display: flex; gap: 8px; align-items: center; }

        .icon-btn {
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            width: 44px; height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white; cursor: pointer; transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* SCORE BOX */
        .score-container {
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            padding: 8px 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);
            color: white; text-align: center; min-width: 60px; height: 44px; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .score-label { font-size: 8px; color: #aaa; font-weight: 700; text-transform: uppercase; }
        .score-val { font-size: 22px; font-weight: 800; line-height: 1; margin-top: 2px; }
        .score-val.overdrive { color: #ffeb3b; text-shadow: 0 0 15px #ffeb3b; }

        /* TIMER BTN (UPDATED) */
        .timer-btn {
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            padding: 0 12px; height: 44px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);
            color: white; display: flex; align-items: center; justify-content: center; gap: 5px;
            cursor: pointer; transition: all 0.2s;
            position: relative; z-index: 100; /* Force on top */
        }
        .timer-btn:hover { transform: scale(1.05); border-color: #ffeb3b; }
        .timer-btn.active { border-color: #ff5252; color: #ff5252; background: rgba(50, 0, 0, 0.8); animation: pulse 1s infinite; }
        .timer-val { font-weight: 800; font-size: 18px; font-variant-numeric: tabular-nums; }
        
        .dropdown-arrow { font-size: 10px; color: #ffeb3b; margin-left: 2px; opacity: 0.8; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); } }

        /* OVERDRIVE METER (Moved Down to fix overlap) */
        #meter-container {
            position: absolute; top: 85px; /* Moved down from 30px */
            left: 50%; transform: translateX(-50%);
            width: 140px; height: 10px; background: rgba(0,0,0,0.5);
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); overflow: hidden;
            z-index: 5;
        }
        #meter-fill {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, #ffeb3b, #ff9800);
            box-shadow: 0 0 10px #ffeb3b;
            transition: width 0.1s linear;
        }
        #overdrive-text {
            position: absolute; top: 100px; /* Moved down to match meter */
            left: 50%; transform: translateX(-50%);
            color: #ffeb3b; font-size: 10px; font-weight: 900; text-transform: uppercase;
            letter-spacing: 2px; opacity: 0; transition: opacity 0.3s; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* CUSTOM POPUP / ALERT */
        #custom-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .popup-box {
            background: #1e1e1e; border: 1px solid #444; padding: 25px; border-radius: 20px;
            width: 80%; max-width: 300px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            transform: scale(0.9); transition: transform 0.2s;
        }
        .popup-msg { color: white; font-size: 16px; margin-bottom: 20px; line-height: 1.4; }
        .popup-btn {
            background: #ffeb3b; color: black; font-weight: 800; border: none; padding: 10px 25px;
            border-radius: 50px; cursor: pointer; text-transform: uppercase; font-size: 14px;
        }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content {
            background: rgba(30, 30, 30, 0.95); width: 85%; max-width: 340px; max-height: 80vh;
            padding: 24px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.15);
            text-align: center; color: white; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow-y: auto; position: relative;
        }
        .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; color: #ffeb3b; }
        
        .menu-btn {
            width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px;
            background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; font-weight: 700; font-size: 14px; text-transform: uppercase;
            cursor: pointer; transition: all 0.2s;
        }
        .menu-btn:active { transform: scale(0.96); background: rgba(255,255,255,0.15); }
        .menu-btn.primary { background: #ffeb3b; color: #000; border: none; }
        .menu-btn.lightning { background: #FFC107; color: #000; border: none; }
        .menu-btn.dash { background: #4CAF50; color: #fff; border: none; }
        .menu-btn.google { background: #fff; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .close-btn { margin-top: 15px; color: #777; font-size: 12px; font-weight: bold; text-transform: uppercase; cursor: pointer; }

        /* LEADERBOARD TABS */
        .lb-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .lb-tab { flex: 1; padding: 8px 4px; font-size: 10px; font-weight: bold; color: #777; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .lb-tab.active { background: #333; color: #ffeb3b; }
        
        .lb-list { text-align: left; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .lb-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
        .lb-rank { color: #ffeb3b; font-weight: bold; width: 25px; }
        .lb-name { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .lb-score { font-weight: bold; }

        /* SHOP & OTHERS */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .shop-item { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .shop-icon { font-size: 30px; margin-bottom: 5px; }
        .shop-name { font-size: 12px; font-weight: bold; color: #ccc; }
        .shop-price { font-size: 11px; color: #ffeb3b; margin: 5px 0; }
        .buy-btn { background: #4caf50; color: white; border: none; border-radius: 50px; padding: 5px 15px; font-size: 10px; font-weight: bold; width: 100%; cursor: pointer; }

        .howto-step { text-align: left; margin-bottom: 15px; font-size: 13px; color: #ddd; line-height: 1.4; display: flex; gap: 10px; }
        .step-icon { font-size: 18px; min-width: 25px; }

        .streak-badge { background: linear-gradient(45deg, #ff9800, #ff5722); padding: 5px 12px; border-radius: 20px; color: white; font-weight: 900; font-size: 14px; transform: rotate(-3deg); box-shadow: 0 4px 10px rgba(255, 87, 34, 0.4); display: none; }
        #unlock-msg { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 235, 59, 0.95); color: black; padding: 15px 30px; border-radius: 50px; font-weight: 900; font-size: 20px; text-transform: uppercase; box-shadow: 0 0 30px rgba(255, 235, 59, 0.5); opacity: 0; pointer-events: none; transition: opacity 0.5s; text-align: center; width: 90%; }
        
        #weapon-bar { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; pointer-events: auto; }
        .weapon-card { width: 60px; height: 60px; background: rgba(0,0,0,0.5); border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.5; transition: all 0.2s; position: relative; overflow: hidden; }
        .weapon-card.active { border-color: #ffeb3b; opacity: 1; transform: scale(1.15); background: rgba(0,0,0,0.8); box-shadow: 0 0 15px rgba(255, 235, 59, 0.3); }
        .weapon-card.locked { filter: grayscale(1); opacity: 0.2; }
        .weapon-icon { font-size: 24px; z-index: 2; position: relative; }
        .weapon-ammo { font-size: 11px; color: #fff; margin-top: 2px; font-weight: bold; z-index: 2; position: relative; }
        .progress-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; transition: height 0.3s ease-out; z-index: 1; }
        #prog-melon { background: rgba(76, 175, 80, 0.6); } #prog-pie { background: rgba(238, 238, 238, 0.6); }   

        #instructions { position: absolute; bottom: 40px; width: 100%; text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 12px; letter-spacing: 3px; text-transform: uppercase; font-weight: 600; pointer-events: none; text-shadow: 0 1px 2px rgba(0,0,0,0.8); transition: opacity 0.5s; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>

    <video id="camera-feed" autoplay playsinline muted></video>
    <canvas id="game-layer"></canvas>
    
    <div id="hud">
        <div class="top-bar">
            <div class="left-icons">
                <div class="icon-btn" onclick="openModal('settings-modal')">‚öôÔ∏è</div>
                <div class="icon-btn" onclick="openModal('shop-modal')">üõí</div>
            </div>

            <div class="right-group">
                <div class="stats-row">
                    <div class="timer-btn" id="dash-btn" onclick="openModeSelect()">
                        <span>‚è±Ô∏è</span>
                        <span class="timer-val" id="timer-display">60</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>

                    <div class="score-container" id="score-box">
                        <div class="score-label">Score</div>
                        <div class="score-val" id="score">0</div>
                    </div>
                </div>

                <div class="icon-btn" onclick="openLeaderboard('classic')">üèÜ</div>
            </div>
        </div>

        <div id="meter-container"><div id="meter-fill"></div></div>
        <div id="overdrive-text">OVERDRIVE 2X</div>

        <div class="streak-badge" id="streak-badge" style="position: absolute; top: 120px; left: 20px;">COMBO x2</div>
        <div id="unlock-msg">WEAPON UNLOCKED!</div>

        <div id="weapon-bar">
            <div class="weapon-card active" id="w-egg" onclick="selectWeapon('egg')">
                <div class="weapon-icon">ü•ö</div>
                <div class="weapon-ammo" id="ammo-egg">‚àû</div>
            </div>
            <div class="weapon-card locked" id="w-melon" onclick="selectWeapon('melon')">
                <div class="progress-fill" id="prog-melon"></div>
                <div class="weapon-icon">üçâ</div>
                <div class="weapon-ammo" id="ammo-melon">0</div>
            </div>
            <div class="weapon-card locked" id="w-pie" onclick="selectWeapon('pie')">
                <div class="progress-fill" id="prog-pie"></div>
                <div class="weapon-icon">ü•ß</div>
                <div class="weapon-ammo" id="ammo-pie">0</div>
            </div>
        </div>
        
        <div id="instructions">Drag Down to Launch</div>
    </div>

    <div id="custom-popup">
        <div class="popup-box">
            <div class="popup-msg" id="popup-text">Message goes here</div>
            <button class="popup-btn" onclick="closePopup()">OK</button>
        </div>
    </div>

    <div id="mode-select-modal" class="modal-overlay" onclick="closeAllModals(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">Select Mode</div>
            
            <button class="menu-btn dash" onclick="startDashMode(60, 'Dash Run')">
                <div>Dash Run üèÉ‚Äç‚ôÇÔ∏è</div>
                <div style="font-size:10px; opacity:0.8;">60 Seconds</div>
            </button>
            
            <button class="menu-btn lightning" onclick="startDashMode(15, 'Lightning Round')">
                <div>Lightning Round ‚ö°</div>
                <div style="font-size:10px; opacity:0.8;">15 Seconds</div>
            </button>

            <button class="menu-btn" onclick="closeAllModals()">Cancel</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="closeAllModals(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="settings-view">
                <div class="modal-title">Settings</div>
                <button class="menu-btn" id="sound-toggle" onclick="toggleSound()">Sound: ON</button>
                <button class="menu-btn" onclick="showHowTo()">How To Play</button>
                <button class="menu-btn primary" id="install-btn" style="display:none;" onclick="handleInstall()">Install App</button>
                <button class="menu-btn" onclick="resetGame()">Reset Game</button>
                <div class="close-btn" onclick="closeAllModals()">Back to Game</div>
            </div>

            <div id="howto-view" style="display:none;">
                <div class="modal-title">How To Play</div>
                <div class="howto-step"><div class="step-icon">üëá</div><div><strong>Aim & Fire:</strong> Drag your finger down to shoot.</div></div>
                <div class="howto-step"><div class="step-icon">‚è±Ô∏è</div><div><strong>Dash Mode:</strong> Click the timer to choose 60s or 15s.</div></div>
                <div class="howto-step"><div class="step-icon">‚ö°</div><div><strong>Overdrive:</strong> Fill the top bar for 2x Points.</div></div>
                <div class="howto-step"><div class="step-icon">üçâ</div><div><strong>Weapons:</strong> Score points to unlock Watermelons and Pies.</div></div>
                <button class="menu-btn primary" onclick="hideHowTo()">Back to Settings</button>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="modal-overlay" onclick="closeAllModals(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">Ammo Shop</div>
            <div style="font-size:12px; color:#aaa; margin-bottom:15px;">Spend your score to buy extra ammo! (Coming Soon)</div>
            
            <div class="shop-grid">
                <div class="shop-item">
                    <div class="shop-icon">üçâ</div>
                    <div class="shop-name">5x Melons</div>
                    <div class="shop-price">500 pts</div>
                    <button class="buy-btn" onclick="showPopup('Shop logic coming soon!')">Buy</button>
                </div>
                <div class="shop-item">
                    <div class="shop-icon">ü•ß</div>
                    <div class="shop-name">3x Pies</div>
                    <div class="shop-price">1000 pts</div>
                    <button class="buy-btn" onclick="showPopup('Shop logic coming soon!')">Buy</button>
                </div>
                <div class="shop-item">
                    <div class="shop-icon">ü•ö</div>
                    <div class="shop-name">Golden Egg</div>
                    <div class="shop-price">5000 pts</div>
                    <button class="buy-btn" onclick="showPopup('Shop logic coming soon!')">Buy</button>
                </div>
                 <div class="shop-item">
                    <div class="shop-icon">üí£</div>
                    <div class="shop-name">Bomb</div>
                    <div class="shop-price">Locked</div>
                    <button class="buy-btn" style="background:#555;">Locked</button>
                </div>
            </div>
            <div class="close-btn" onclick="closeAllModals()">Back to Game</div>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal-overlay" onclick="closeAllModals(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">Top Shooters</div>
            
            <div class="lb-tabs">
                <div class="lb-tab active" id="tab-classic" onclick="switchLbTab('classic')">CLASSIC</div>
                <div class="lb-tab" id="tab-dash" onclick="switchLbTab('dash')">DASH (60s)</div>
                <div class="lb-tab" id="tab-lightning" onclick="switchLbTab('lightning')">‚ö° 15s</div>
            </div>

            <div class="user-auth-area">
                <button id="login-btn" class="menu-btn google" onclick="googleLogin()">
                    <span style="font-weight:900; color:#4285F4">G</span> Login with Google
                </button>
                <div id="user-profile">
                    <img id="user-avatar" src="" alt="">
                    <div id="user-name" style="font-size:14px; font-weight:bold;">Player</div>
                </div>
            </div>

            <div class="lb-list" id="lb-list">
                <div style="color:#777; font-size:12px;">Loading scores...</div>
            </div>

            <button class="menu-btn primary" id="submit-score-btn" style="display:none;" onclick="submitHighScore()">Submit Score</button>
            <div class="close-btn" onclick="closeAllModals()">Back to Game</div>
        </div>
    </div>

<script>
// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyAbBGS-VPX5Dk8w9muR8RdTWTArsur211U",
  authDomain: "eggshot-ar.firebaseapp.com",
  projectId: "eggshot-ar",
  storageBucket: "eggshot-ar.firebasestorage.app",
  messagingSenderId: "589796886773",
  appId: "1:589796886773:web:2d3c4e116471e509e4ddbc"
};

// Initialize Firebase
let db, auth, currentUser;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    
    auth.onAuthStateChanged(user => {
        currentUser = user;
        updateAuthUI();
    });
} catch (e) {
    console.warn("Firebase not configured properly.", e);
}

// --- CUSTOM POPUP LOGIC ---
function showPopup(msg) {
    document.getElementById('popup-text').innerText = msg;
    document.getElementById('custom-popup').style.display = 'flex';
}
function closePopup() {
    document.getElementById('custom-popup').style.display = 'none';
}

// --- DASH MODE / TIMER LOGIC ---
let gameMode = 'classic'; // 'classic', 'dash', 'lightning'
let dashTime = 60;
let dashInterval = null;
let activeModeName = "";

function openModeSelect() {
    if(gameMode !== 'classic') {
        // If already in a mode, ask to stop?
        if(!confirm("Stop current timer?")) return;
        endDashMode();
    }
    openModal('mode-select-modal');
}

function startDashMode(time, name) {
    closeAllModals();

    // Confirm start if score > 0
    if (score > 0) {
        if(!confirm(`Start ${name}? Score will reset!`)) return;
    }
    
    // Reset Game for Mode
    gameMode = (time === 15) ? 'lightning' : 'dash';
    activeModeName = name;
    score = 0;
    dashTime = time;
    
    document.getElementById('score').innerText = 0;
    document.getElementById('dash-btn').classList.add('active');
    document.getElementById('timer-display').innerText = dashTime;
    
    // Start Interval
    clearInterval(dashInterval);
    dashInterval = setInterval(() => {
        dashTime--;
        document.getElementById('timer-display').innerText = dashTime;
        
        if (dashTime <= 0) {
            endDashMode();
        }
    }, 1000);
    
    showPopup(`${name.toUpperCase()}!\n${time} Seconds. Go!`);
}

function endDashMode() {
    clearInterval(dashInterval);
    
    let finalScore = score;
    let finishedMode = gameMode;
    
    gameMode = 'classic';
    document.getElementById('dash-btn').classList.remove('active');
    document.getElementById('timer-display').innerText = "60";
    
    showPopup(`TIME'S UP!\nFinal Score: ${finalScore}`);
    
    // Auto open leaderboard to encourage submit
    setTimeout(() => {
        openLeaderboard(finishedMode); 
    }, 1500);
}

// --- AUTH & LEADERBOARD LOGIC ---
let currentLbTab = 'classic';

function googleLogin() {
    if(!auth) return showPopup("Firebase not initialized!");
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
        .then((result) => { console.log("Logged in:", result.user); })
        .catch((error) => { showPopup("Login Failed: " + error.message); });
}

function updateAuthUI() {
    if(currentUser) {
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('user-profile').style.display = 'flex';
        document.getElementById('user-avatar').src = currentUser.photoURL;
        document.getElementById('user-name').innerText = currentUser.displayName.split(' ')[0];
        document.getElementById('submit-score-btn').style.display = 'block';
    } else {
        document.getElementById('login-btn').style.display = 'flex';
        document.getElementById('user-profile').style.display = 'none';
        document.getElementById('submit-score-btn').style.display = 'none';
    }
}

function switchLbTab(tab) {
    currentLbTab = tab;
    document.querySelectorAll('.lb-tab').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    loadScores();
}

function openLeaderboard(tab = 'classic') {
    openModal('leaderboard-modal');
    switchLbTab(tab);
}

async function loadScores() {
    if(!db) return;
    const list = document.getElementById('lb-list');
    list.innerHTML = '<div style="color:#777; font-size:12px;">Loading scores...</div>';
    
    // Determine which field to sort by based on tab
    // Map tabs to firebase fields:
    // classic -> highScore
    // dash -> dashScore
    // lightning -> lightningScore
    
    let sortField = 'highScore';
    if (currentLbTab === 'dash') sortField = 'dashScore';
    if (currentLbTab === 'lightning') sortField = 'lightningScore';
    
    try {
        const q = await db.collection('scores')
            .where(sortField, '>', 0) // Only get scores that exist
            .orderBy(sortField, 'desc')
            .limit(10)
            .get();
            
        list.innerHTML = '';
        let rank = 1;
        q.forEach(doc => {
            const d = doc.data();
            let displayScore = d[sortField];
            
            list.innerHTML += `
                <div class="lb-row">
                    <div class="lb-rank">${rank++}.</div>
                    <div class="lb-name">${d.name}</div>
                    <div class="lb-score">${displayScore}</div>
                </div>`;
        });
        if(rank === 1) list.innerHTML = '<div style="color:#777; font-size:12px;">No scores yet. Be the first!</div>';
    } catch(e) {
        list.innerHTML = '<div style="color:red; font-size:12px;">Error loading data.</div>';
        console.error(e);
    }
}

async function submitHighScore() {
    if(!currentUser || !db) return;
    
    const userRef = db.collection('scores').doc(currentUser.uid);
    
    try {
        const doc = await userRef.get();
        let data = doc.exists ? doc.data() : {};
        
        let updates = {
            name: currentUser.displayName,
            photo: currentUser.photoURL,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Determine which score field to update based on the tab we are viewing
        // (Assuming the user just finished a game in that mode)
        let fieldName = 'highScore';
        let modeDisplayName = "Classic";
        
        if (currentLbTab === 'dash') { fieldName = 'dashScore'; modeDisplayName = "Dash"; }
        if (currentLbTab === 'lightning') { fieldName = 'lightningScore'; modeDisplayName = "Lightning"; }

        if (!data[fieldName] || score > data[fieldName]) {
            updates[fieldName] = score;
            await userRef.set(updates, { merge: true });
            showPopup(`${modeDisplayName} Score Submitted!`);
            loadScores(); // Refresh list
        } else {
            showPopup(`New score isn't higher than your best ${modeDisplayName} record.`);
        }
        
    } catch(e) {
        showPopup("Error: " + e.message);
    }
}

// --- UI HELPERS ---
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeAllModals() { 
    document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none'); 
    document.getElementById('settings-view').style.display = 'block';
    document.getElementById('howto-view').style.display = 'none';
}

function showHowTo() {
    document.getElementById('settings-view').style.display = 'none';
    document.getElementById('howto-view').style.display = 'block';
}
function hideHowTo() {
    document.getElementById('howto-view').style.display = 'none';
    document.getElementById('settings-view').style.display = 'block';
}

// --- AUDIO SYSTEM ---
let audioCtx = null;
let soundEnabled = true;

function playSfx(type) {
    if (!soundEnabled) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const now = audioCtx.currentTime;

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    if (type === 'stretch') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(120, now);
        osc.frequency.linearRampToValueAtTime(220, now + 0.2);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.2);
        osc.start(now); osc.stop(now + 0.2);
    } 
    else if (type === 'fire') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(50, now + 0.2);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
        osc.start(now); osc.stop(now + 0.2);
    } 
    else if (type === 'hit') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.exponentialRampToValueAtTime(20, now + 0.1);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
    }
}

function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('sound-toggle').innerText = `Sound: ${soundEnabled ? 'ON' : 'OFF'}`;
}

// --- PWA LOGIC ---
let deferredPrompt;
const installBtn = document.getElementById('install-btn');

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW registration failed:', err));
    });
}

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';
});

function handleInstall() {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
        deferredPrompt = null;
        installBtn.style.display = 'none';
        closeAllModals();
    });
}

function resetGame() {
    score = 0; hitsWithEgg = 0; streak = 0; bonusMeter = 0; overdrive = false;
    document.getElementById('score').innerText = 0;
    
    // Stop Timer
    clearInterval(dashInterval);
    gameMode = 'classic';
    document.getElementById('dash-btn').classList.remove('active');
    document.getElementById('timer-display').innerText = "60";

    document.getElementById('prog-melon').style.height = '0%';
    document.getElementById('prog-pie').style.height = '0%';
    for (let key in WEAPONS) {
        if(key !== 'egg') { WEAPONS[key].ammo = 0; WEAPONS[key].unlockedFlag = false; }
    }
    currentWeapon = 'egg';
    updateWeaponUI();
    closeAllModals();
}

// --- CONFIG ---
const C = { zSpeed: 60, targetDist: 800, hitWindow: 200, focalLength: 900, anchorYRatio: 0.65 };

// --- TARGET TYPES (New Variety) ---
const TARGETS = {
    'person':   { label: 'PLAYER',  color: '#f44336', hp: 100 },
    'cup':      { label: 'BONUS',   color: '#ffeb3b', hp: 10, bonus: 50 },
    'bottle':   { label: 'BONUS',   color: '#ffeb3b', hp: 10, bonus: 50 },
    'backpack': { label: 'AMMO',    color: '#2196f3', hp: 30, ammoType: 'melon', amount: 5 },
    'handbag':  { label: 'AMMO',    color: '#2196f3', hp: 30, ammoType: 'pie', amount: 3 }
};

// --- WEAPON DEFINITIONS ---
let WEAPONS = {
    egg:    { id: 'egg',    gravity: 0.85, damage: 15,  speed: 60, ammo: -1, unlock: 0 },
    melon:  { id: 'melon',  gravity: 1.3,  damage: 60,  speed: 45, ammo: 0,  unlock: 100 },
    pie:    { id: 'pie',    gravity: 2.0,  damage: 200, speed: 40, ammo: 0,  unlock: 300 }
};

let currentWeapon = 'egg';

// --- STATE ---
let canvas, ctx, video;
let dragging = false;
let dragPos = { x: 0, y: 0 };
let flyingEgg = null; 
let activeTargets = []; 
let particles = [];
let popups = []; 
let score = 0, bonusMeter = 0, overdrive = false;
let streak = 0;
let shake = 0;
let hitsWithEgg = 0; 
let hasDragged = false;
const seedOffsets = Array(10).fill(0).map(() => Math.random()); 

// --- INIT ---
window.onload = async () => {
    canvas = document.getElementById('game-layer');
    ctx = canvas.getContext('2d');
    video = document.getElementById('camera-feed');
    resize();
    window.addEventListener('resize', resize);

    const startDrag = (x, y) => {
        if (flyingEgg) return;
        if (x > window.innerWidth * 0.85) return; 
        if (y > window.innerHeight * 0.3) { 
            dragging = true; 
            dragPos = { x, y }; 
            playSfx('stretch');
            if (!hasDragged) {
                hasDragged = true;
                document.getElementById('instructions').style.opacity = 0;
            }
        }
    };
    const moveDrag = (x, y) => { if (dragging) dragPos = { x, y }; };
    const endDrag = () => { if (dragging) { dragging = false; fire(); } };

    canvas.addEventListener('touchstart', e => { 
        if(e.target.closest('.weapon-card') || e.target.closest('#settings-trigger')) return;
        e.preventDefault(); startDrag(e.touches[0].clientX, e.touches[0].clientY); 
    }, {passive:false});
    canvas.addEventListener('touchmove', e => { e.preventDefault(); moveDrag(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
    canvas.addEventListener('touchend', e => { 
        if(e.target.closest('.weapon-card') || e.target.closest('#settings-trigger')) return;
        e.preventDefault(); endDrag(); 
    }, {passive:false});
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.onloadedmetadata = () => { initAI(); };
    } catch(e) {}

    updateWeaponUI();
    loop();
};

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

function selectWeapon(id) {
    const w = WEAPONS[id];
    if (score >= w.unlock) {
        if (w.ammo === 0) { shakeElement(document.getElementById('w-' + id)); return; }
        currentWeapon = id;
        updateWeaponUI();
    }
}

function updateWeaponUI() {
    document.querySelectorAll('.weapon-card').forEach(el => el.classList.remove('active'));
    document.getElementById('w-' + currentWeapon).classList.add('active');

    for (let key in WEAPONS) {
        let w = WEAPONS[key];
        let ammoTxt = w.ammo === -1 ? '‚àû' : w.ammo;
        document.getElementById('ammo-' + key).innerText = ammoTxt;
        let el = document.getElementById('w-' + key);
        if (score >= w.unlock) {
            el.classList.remove('locked');
            if (w.ammo === 0) el.style.opacity = 0.5; else el.style.opacity = 1.0;
        } else {
            el.classList.add('locked'); el.style.opacity = 0.2;
        }
    }
}

function shakeElement(el) {
    el.style.transform = "translateX(-5px)";
    setTimeout(() => el.style.transform = "translateX(5px)", 50);
    setTimeout(() => el.style.transform = "translateX(0)", 100);
}

function checkUnlocks() {
    if (score >= WEAPONS.melon.unlock && !WEAPONS.melon.unlockedFlag) {
        WEAPONS.melon.unlockedFlag = true; WEAPONS.melon.ammo += 25; 
        showUnlock("25 WATERMELONS UNLOCKED!"); updateWeaponUI();
    }
    if (score >= WEAPONS.pie.unlock && !WEAPONS.pie.unlockedFlag) {
        WEAPONS.pie.unlockedFlag = true; WEAPONS.pie.ammo += 5; 
        showUnlock("5 CREAM PIES UNLOCKED!"); updateWeaponUI();
    }
}

function grantAmmo(type, amount) {
    if (score < WEAPONS[type].unlock) return;
    WEAPONS[type].ammo += amount;
    updateWeaponUI();
}

function showUnlock(msg) {
    const el = document.getElementById('unlock-msg');
    el.innerText = msg; el.style.opacity = 1;
    el.style.transform = "translate(-50%, -50%) scale(1.1)";
    setTimeout(() => { el.style.opacity = 0; el.style.transform = "translate(-50%, -50%) scale(1)"; }, 3000);
}

// --- LOGIC ---
function fire() {
    const cx = window.innerWidth / 2;
    const anchorY = window.innerHeight * C.anchorYRatio; 
    let dx = cx - dragPos.x;
    let dy = anchorY - dragPos.y; 
    const w = WEAPONS[currentWeapon];

    if (w.ammo > 0) {
        w.ammo--; updateWeaponUI();
        if (w.ammo === 0) setTimeout(() => { if(currentWeapon === w.id) currentWeapon = 'egg'; updateWeaponUI(); }, 500);
    }
    
    playSfx('fire');

    let lob = -6;
    if (w.id === 'pie') lob = -12; 
    if (w.id === 'melon') lob = -9;
    let launchVy = (dy * 0.13) + lob; 

    flyingEgg = { type: w.id, x: cx, y: anchorY + 120, z: 0, vx: dx * 0.16, vy: launchVy, vz: w.speed };
    shake = w.id === 'pie' ? 20 : 10; 
}

function update() {
    // Particles
    for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.04;
        if(p.life <= 0) particles.splice(i,1);
    }
    // Popups
    for(let i=popups.length-1; i>=0; i--) {
        let p = popups[i]; p.y -= 2; p.life -= 0.02;
        if(p.life <= 0) popups.splice(i,1);
    }
    
    // Bonus Meter Decay
    if (bonusMeter > 0) bonusMeter -= 0.15;
    if (bonusMeter < 0) bonusMeter = 0;
    if (overdrive && bonusMeter <= 0) {
        overdrive = false;
        document.getElementById('overdrive-text').style.opacity = 0;
        document.getElementById('score').classList.remove('overdrive');
    }
    document.getElementById('meter-fill').style.width = bonusMeter + '%';

    if (!flyingEgg) return;

    const w = WEAPONS[flyingEgg.type];
    flyingEgg.x += flyingEgg.vx; flyingEgg.y += flyingEgg.vy; flyingEgg.z += flyingEgg.vz; flyingEgg.vy += w.gravity; 

    if (flyingEgg.z > 2500 || flyingEgg.y > 2000) { 
        if(flyingEgg) { streak = 0; updateUI(); }
        flyingEgg = null; return; 
    }

    if (Math.abs(flyingEgg.z - C.targetDist) < C.hitWindow) checkHit();
}

function checkHit() {
    const scale = C.focalLength / (C.focalLength + flyingEgg.z);
    const screenX = (flyingEgg.x - window.innerWidth/2) * scale + window.innerWidth/2;
    const screenY = (flyingEgg.y - window.innerHeight/2) * scale + window.innerHeight/2;
    const sx = canvas.width / video.videoWidth;
    const sy = canvas.height / video.videoHeight;
    const wInfo = WEAPONS[flyingEgg.type];

    for (let i = activeTargets.length - 1; i >= 0; i--) {
        let t = activeTargets[i];
        let tx = t.bbox[0] * sx, ty = t.bbox[1] * sy, tw = t.bbox[2] * sx, th = t.bbox[3] * sy;

        if (screenX > tx && screenX < tx + tw && screenY > ty && screenY < ty + th) {
            
            // Determine Target Type & Config
            let tType = TARGETS[t.type] || TARGETS['person'];
            
            let damage = wInfo.damage;
            let isHeadshot = (screenY < ty + (th * 0.25)); 
            if (isHeadshot) damage *= 2; 
            if (overdrive) damage *= 2; // Overdrive Multiplier

            createExplosion(screenX, screenY, scale, wInfo.id); 
            playSfx('hit');
            shake = wInfo.id === 'pie' ? 40 : 15; 

            if (t.hp > 0) {
                t.hp -= damage;
                score += damage;
                checkUnlocks(); 
                
                // Bonus Meter Logic
                bonusMeter = Math.min(100, bonusMeter + (tType.bonus || 15));
                if (bonusMeter >= 100 && !overdrive) {
                    overdrive = true;
                    document.getElementById('overdrive-text').style.opacity = 1;
                    document.getElementById('score').classList.add('overdrive');
                }

                // Progression (FASTER REFILLS)
                if (currentWeapon === 'egg') {
                    hitsWithEgg++;
                    // Melon Refill: Every 5 hits
                    let mProg = (hitsWithEgg % 5) / 5;
                    document.getElementById('prog-melon').style.height = (mProg * 100) + '%';
                    if (hitsWithEgg % 5 === 0) { grantAmmo('melon', 5); document.getElementById('prog-melon').style.height = '0%'; }
                    
                    // Pie Refill: Every 15 hits
                    let pProg = (hitsWithEgg % 15) / 15;
                    document.getElementById('prog-pie').style.height = (pProg * 100) + '%';
                    if (hitsWithEgg % 15 === 0) { grantAmmo('pie', 3); document.getElementById('prog-pie').style.height = '0%'; }
                }
                
                // Ammo Drops from backpacks
                if (tType.ammoType) {
                    grantAmmo(tType.ammoType, tType.amount);
                    createPopup(screenX, screenY-30, `+${tType.amount} ${tType.ammoType.toUpperCase()}`, true);
                }
                
                createPopup(screenX, screenY, `-${damage}`, isHeadshot);
                
                if (t.hp <= 0) {
                    t.hp = 0;
                    createPopup(screenX, screenY - 80, "KO!", true);
                    streak++; setTimeout(() => { t.hp = 100; }, 4000);
                } else { streak++; }
            } else {
                score += 5; createPopup(screenX, screenY, "OVERKILL", false);
            }
            document.getElementById('score').innerText = score;
            updateUI();
            flyingEgg = null; 
            break;
        }
    }
}

function updateUI() {
    const sBadge = document.getElementById('streak-badge');
    if(streak > 1) { sBadge.style.display = 'block'; sBadge.innerText = `COMBO x${streak}`; } 
    else { sBadge.style.display = 'none'; }
}

function loop() {
    requestAnimationFrame(loop);
    update();
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (shake > 0) {
        let sx = (Math.random() - 0.5) * shake;
        let sy = (Math.random() - 0.5) * shake;
        ctx.save(); ctx.translate(sx, sy); shake *= 0.9;
    }

    drawTargets();

    for (let p of particles) {
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fill();
    }
    ctx.globalAlpha = 1.0;

    let apexX, apexY;
    if (dragging && !flyingEgg) { apexX = dragPos.x; apexY = dragPos.y; } 
    else { apexX = canvas.width / 2; apexY = (canvas.height * C.anchorYRatio) + 160; }

    const w = WEAPONS[currentWeapon];

    if (!flyingEgg || (flyingEgg && flyingEgg.z > 50)) { drawBands(apexX, apexY); }

    if (!flyingEgg) {
        drawPouch(apexX, apexY); drawProjectile(apexX, apexY, 1.0, w.id);
    } else {
        const scale = C.focalLength / (C.focalLength + flyingEgg.z);
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        const sx = (flyingEgg.x - cx) * scale + cx;
        const sy = (flyingEgg.y - cy) * scale + cy;
        drawProjectile(sx, sy, scale, flyingEgg.type);
    }

    ctx.textAlign = "center";
    for(let p of popups) {
        ctx.shadowColor = "black"; ctx.shadowBlur = 4;
        ctx.fillStyle = p.color;
        let fontSize = p.size;
        if (p.type === "small") fontSize = 16;
        ctx.font = `900 ${fontSize}px 'Segoe UI'`; 
        ctx.globalAlpha = p.life;
        ctx.fillText(p.text, p.x, p.y);
        ctx.lineWidth = 1; ctx.strokeStyle = "rgba(0,0,0,0.5)";
        ctx.strokeText(p.text, p.x, p.y);
        ctx.shadowBlur = 0;
    }
    ctx.globalAlpha = 1.0;

    if (shake > 0) ctx.restore();
}

function drawProjectile(x, y, scale, type) {
    let r = 24 * scale;
    if (type === 'melon') r *= 1.4;
    if (type === 'pie') r *= 1.6;
    if (r < 1) return;
    ctx.save(); ctx.translate(x, y);

    if (type === 'egg') {
        if (scale === 1.0) { ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.beginPath(); ctx.ellipse(0, 0, r, r, 0, 0, PI2); ctx.fill(); }
        ctx.beginPath(); ctx.ellipse(0, -2, r * 0.88, r, 0, 0, PI2);
        let grad = ctx.createRadialGradient(-r/3, -r/3, r/5, 0, 0, r);
        grad.addColorStop(0, "#ffffff"); grad.addColorStop(1, "#dcdcdc");
        ctx.fillStyle = grad; ctx.fill();
    } 
    else if (type === 'melon') {
        let grad = ctx.createRadialGradient(-r/3, -r/3, r/5, 0, 0, r);
        grad.addColorStop(0, "#66bb6a"); grad.addColorStop(1, "#1b5e20");
        ctx.fillStyle = grad;
        ctx.beginPath(); ctx.arc(0, 0, r, 0, PI2); ctx.fill();
        ctx.save(); ctx.beginPath(); ctx.arc(0,0,r,0,PI2); ctx.clip();
        ctx.strokeStyle = "#0d3310"; ctx.lineWidth = r * 0.15;
        for(let i=1; i<=3; i++) {
            let startX = -r + (i * r * 0.5);
            ctx.beginPath(); ctx.moveTo(startX, -r);
            for(let j=0; j<=10; j++) {
                let py = -r + (j * (r*2)/10);
                let wobble = Math.sin(j * 1.5 + seedOffsets[i]) * (r * 0.15);
                ctx.lineTo(startX + wobble, py);
            }
            ctx.stroke();
        }
        ctx.restore();
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.beginPath(); ctx.ellipse(-r*0.4, -r*0.4, r*0.2, r*0.1, -0.5, 0, PI2); ctx.fill();
    }
    else if (type === 'pie') {
        ctx.fillStyle = "#cfd8dc"; 
        ctx.beginPath(); ctx.ellipse(0, r*0.2, r, r*0.5, 0, 0, PI2); ctx.fill();
        ctx.strokeStyle = "#90a4ae"; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = "#d7ccc8"; 
        ctx.beginPath(); ctx.ellipse(0, 0, r*0.9, r*0.4, 0, 0, PI2); ctx.fill();
        ctx.fillStyle = "#fff";
        let puffR = r * 0.45;
        const puffOffsets = [[-0.5, -0.2], [0.5, -0.2], [0, -0.6], [-0.3, 0.2], [0.3, 0.2], [0, 0]];
        puffOffsets.forEach(po => {
            ctx.beginPath(); ctx.arc(po[0]*r, po[1]*r, puffR, 0, PI2); ctx.fill();
            ctx.fillStyle = "rgba(200,200,200,0.1)"; ctx.beginPath(); ctx.arc(po[0]*r, po[1]*r + 2, puffR*0.8, 0, PI2); ctx.fill();
            ctx.fillStyle = "#fff"; 
        });
        ctx.fillStyle = "#d50000"; ctx.beginPath(); ctx.arc(0, -r*0.3, r*0.22, 0, PI2); ctx.fill();
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(-r*0.08, -r*0.38, r*0.06, 0, PI2); ctx.fill();
    }
    ctx.restore();
}

function drawTargets() {
    const sx = canvas.width / video.videoWidth;
    const sy = canvas.height / video.videoHeight;
    const now = Date.now();
    activeTargets.forEach(t => {
        if (now - t.lastSeen > 1000) return;
        let x = t.bbox[0] * sx; let y = t.bbox[1] * sy;
        let w = t.bbox[2] * sx; let cx = x + w/2; let cy = y - 50; 
        
        let config = TARGETS[t.type] || TARGETS['person'];

        // Reticle
        ctx.strokeStyle = config.color; ctx.lineWidth = 3;
        const L = 20;
        ctx.beginPath();
        ctx.moveTo(x, y + L); ctx.lineTo(x, y); ctx.lineTo(x + L, y); // TL
        ctx.moveTo(x + w - L, y); ctx.lineTo(x + w, y); ctx.lineTo(x + w, y + L); // TR
        ctx.moveTo(x, y + t.bbox[3]*sy - L); ctx.lineTo(x, y + t.bbox[3]*sy); ctx.lineTo(x + L, y + t.bbox[3]*sy); // BL
        ctx.moveTo(x + w - L, y + t.bbox[3]*sy); ctx.lineTo(x + w, y + t.bbox[3]*sy); ctx.lineTo(x + w, y + t.bbox[3]*sy - L); // BR
        ctx.stroke();

        if (t.hp > 0) {
            const barWidth = Math.min(Math.max(w, 80), 180);
            const barHeight = 12;
            const barX = cx - barWidth/2;
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.beginPath(); ctx.roundRect(barX, cy, barWidth, barHeight, 6); ctx.fill();
            let pct = t.hp / 100;
            ctx.fillStyle = config.color;
            ctx.beginPath(); ctx.roundRect(barX + 2, cy + 2, (barWidth - 4) * pct, barHeight - 4, 4); ctx.fill();
            
            // Label
            ctx.fillStyle = "white"; ctx.font = "bold 10px sans-serif";
            ctx.fillText(config.label, cx, cy - 8);
        } else {
            ctx.shadowColor = "black"; ctx.shadowBlur = 10;
            ctx.font = "80px Arial"; ctx.fillText("üíÄ", cx, cy + 50); ctx.shadowBlur = 0;
        }
    });
}

function drawBands(tipX, tipY) {
    const w = canvas.width;
    const ay = canvas.height * C.anchorYRatio; 
    const pouchWidthHalf = 25; 
    ctx.beginPath(); ctx.moveTo(0, ay); ctx.quadraticCurveTo(w * 0.2, tipY, tipX - pouchWidthHalf, tipY);
    ctx.lineWidth = 14; ctx.strokeStyle = "rgba(230, 180, 120, 0.9)"; ctx.lineCap = "round"; ctx.stroke();
    ctx.lineWidth = 6; ctx.strokeStyle = "rgba(255, 230, 200, 0.4)"; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(w, ay); ctx.quadraticCurveTo(w * 0.8, tipY, tipX + pouchWidthHalf, tipY);
    ctx.lineWidth = 14; ctx.strokeStyle = "rgba(230, 180, 120, 0.9)"; ctx.stroke();
    ctx.lineWidth = 6; ctx.strokeStyle = "rgba(255, 230, 200, 0.4)"; ctx.stroke();
}

function drawPouch(x, y) {
    ctx.save(); ctx.translate(x, y);
    const rot = (x - window.innerWidth/2) * 0.0015; ctx.rotate(rot);
    ctx.fillStyle = "#2d2d2d"; 
    ctx.beginPath(); ctx.moveTo(-30, -20); ctx.lineTo(30, -20); ctx.lineTo(25, 25); ctx.lineTo(-25, 25); ctx.closePath(); ctx.fill();
    ctx.strokeStyle = "#111"; ctx.lineWidth = 2; ctx.stroke();
    ctx.strokeStyle = "#555"; ctx.lineWidth = 1; ctx.setLineDash([3, 3]);
    ctx.beginPath(); ctx.moveTo(-25, -15); ctx.lineTo(25, -15); ctx.lineTo(20, 20); ctx.lineTo(-20, 20); ctx.closePath(); ctx.stroke();
    ctx.restore();
}

function createExplosion(x, y, scale, type) {
    let color1 = '#ffeb3b'; let color2 = '#ffffff'; 
    if (type === 'melon') { color1 = '#d32f2f'; color2 = '#388e3c'; } 
    if (type === 'pie') { color1 = '#ffffff'; color2 = '#d50000'; } 
    for(let i=0; i<30; i++) {
        particles.push({
            x: x, y: y,
            vx: (Math.random()-0.5) * 35 * scale,
            vy: (Math.random()-0.5) * 35 * scale,
            life: 1.0,
            color: Math.random() > 0.4 ? color1 : color2,
            r: (Math.random() * 8 + 3) * scale
        });
    }
}

function createPopup(x, y, text, isCrit, type) {
    popups.push({
        x: x, y: y - 50,
        text: text,
        life: 1.0,
        color: isCrit ? "#ff5252" : "#ffffff",
        size: isCrit ? 50 : 35,
        type: type
    });
}

async function initAI() {
    const model = await cocoSsd.load();
    setInterval(async () => {
        if(video.readyState===4) {
            const preds = await model.detect(video);
            // Filter only valid targets
            const validPreds = preds.filter(p => TARGETS[p.class]);
            updateActiveTargets(validPreds);
        }
    }, 200);
}

function updateActiveTargets(detectedItems) {
    const now = Date.now();
    detectedItems.forEach(p => {
        let matched = false;
        for (let t of activeTargets) {
            let pCx = p.bbox[0] + p.bbox[2]/2;
            let pCy = p.bbox[1] + p.bbox[3]/2;
            let tCx = t.bbox[0] + t.bbox[2]/2;
            let tCy = t.bbox[1] + t.bbox[3]/2;
            if ((pCx - tCx)**2 + (pCy - tCy)**2 < 20000) { 
                t.bbox = p.bbox; t.lastSeen = now; matched = true; break;
            }
        }
        // Store Type
        if (!matched) activeTargets.push({ bbox: p.bbox, hp: 100, lastSeen: now, type: p.class });
    });
    activeTargets = activeTargets.filter(t => now - t.lastSeen < 2000);
}
const PI2 = Math.PI * 2;
</script>
</body>
</html>